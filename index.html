<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>ä¸­è¯æ°‘åœ‹æ°£è±¡åœ°éœ‡ç´”æ–‡å­—è¨Šæ¯</title>
    <style>
        :root {
            --bg-color: #000000;
            --weather-color: #00E1FF;
            --weather-dim: #006064;    
            --quake-color: #FF4500;
            --quake-dim: #8B2500;
            --alert-bg: #330000;      
        }

        body {
            background-color: var(--bg-color);
            color: var(--weather-color);
            font-family: "Courier New", Courier, monospace;
            margin: 0; padding: 15px;
            font-size: 16px; line-height: 1.4;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden; padding-bottom: 80px;
        }

        body.alarm-active { animation: red-flash 1s infinite; }
        @keyframes red-flash {
            0% { background-color: var(--bg-color); }
            50% { background-color: var(--alert-bg); }
            100% { background-color: var(--bg-color); }
        }

        a { text-decoration: none; color: inherit; -webkit-tap-highlight-color: transparent; }
        * { box-sizing: border-box; }

        header {
            border-bottom: 2px dashed var(--weather-color);
            padding-bottom: 10px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: flex-end;
        }
        h1 { font-size: 1.2rem; margin: 0; }
        .sys-info { font-size: 0.7rem; color: var(--weather-dim); text-align: right; }
        
        .monitor-badge {
            display: inline-block; font-size: 0.7rem; padding: 2px 6px; 
            border: 1px solid #333; color: #555; margin-top: 5px; transition: all 0.3s;
        }
        .monitor-active {
            border-color: #00FF00; color: #00FF00;
            box-shadow: 0 0 8px rgba(0,255,0,0.2);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% {opacity:1;} 50% {opacity:0.6;} 100% {opacity:1;} }

        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn {
            flex: 1; padding: 12px;
            background: #111; color: var(--weather-dim);
            border: 1px dashed var(--weather-dim);
            font-family: inherit; font-size: 0.9rem; cursor: pointer;
            text-transform: uppercase; border-radius: 4px; color: #fff;
        }
        .btn:active { background: #222; transform: translateY(2px); }
        .btn-on { border-color: #00FF00; color: #00FF00; background: rgba(0,20,0,0.3); }

        /* --- åœ°éœ‡å¡ç‰‡æ¨£å¼ --- */
        #quakeArea { 
            margin-bottom: 20px; display: none; cursor: pointer;
            transition: transform 0.1s;
        }
        .quake-card {
            display: block; 
            border: 2px solid var(--quake-color); 
            color: var(--quake-color);
            padding: 30px 20px 20px 20px; 
            position: relative;
            background: rgba(50, 10, 0, 0.2); 
            box-shadow: 0 0 8px rgba(255, 69, 0, 0.2);
            overflow: hidden; 
        }
        .quake-card::before {
            content: "[ âš ï¸ SEISMIC_ALERT ]";
            position: absolute; top: -1px; left: -1px; 
            background: var(--quake-color); color: #000; 
            padding: 2px 8px; font-weight: bold; font-size: 0.75rem;
        }
        .quake-card::after { 
            content: "â†—"; position: absolute; top: 10px; right: 10px; 
            font-size: 1.5rem; opacity: 0.5; pointer-events: none;
        }
        
        .quake-top-row {
            display: flex; justify-content: space-between; font-size: 0.8rem;
            margin-bottom: 5px; 
            padding-right: 30px; 
        }

        .quake-main { font-size: 1.4rem; font-weight: bold; margin: 5px 0 10px 0; line-height: 1.2; }
        
        .quake-details {
            font-size: 0.95rem; opacity: 0.9; margin-top: 10px; padding-top: 10px;
            border-top: 1px dashed var(--quake-dim); 
            line-height: 1.5; 
            white-space: pre-wrap;
            word-break: break-word; 
            overflow-wrap: break-word;
        }
        .alert-blink { animation: rapid-blink 1.5s infinite; color: #FF4500; }
        @keyframes rapid-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* --- æ°£è±¡æ¨£å¼ (Liteç‰ˆ) --- */
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; margin-bottom: 3px; color: var(--weather-dim); }
        
        select {
            background-color: #051a24; color: var(--weather-color);
            border: 1px solid var(--weather-color); padding: 10px; width: 100%;
            font-family: inherit; font-size: 1.1rem; border-radius: 0; outline: none; -webkit-appearance: none; 
        }

        .location-header {
            font-size: 1.1rem; border-left: 4px solid var(--weather-color);
            padding-left: 10px; margin: 20px 0 10px 0; color: #fff;
        }

        .forecast-grid {
            display: grid; gap: 10px;
        }

        .forecast-card {
            border: 1px solid var(--weather-dim); padding: 12px; position: relative;
            background: rgba(0, 30, 30, 0.3);
        }
        .forecast-card::before {
            content: attr(data-period); position: absolute; top: 0; right: 0;
            background: var(--weather-dim); color: #000; padding: 2px 6px; font-size: 0.7rem; font-weight: bold;
        }
        
        .weather-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px;}
        .wx-text { font-size: 1.3rem; font-weight: bold; margin-bottom: 5px; }
        
        /* --- [ä¿®æ”¹éƒ¨åˆ†é–‹å§‹] çµ±ä¸€æ–‡å­—æ¨£å¼ --- */
        /* æ™‚é–“æ–‡å­— (æ–°å¢) */
        .time-text { 
            font-size: 1.2rem;   /* èˆ‡æº«åº¦ç›¸åŒ */
            color: #fff;         /* èˆ‡æº«åº¦ç›¸åŒ */
            margin-bottom: 5px; 
        }
        
        /* æº«åº¦æ–‡å­— (ç¶­æŒåŸæ¨£) */
        .temp-text { 
            font-size: 1.2rem; 
            color: #fff; 
        }
        
        /* é™é›¨æ©Ÿç‡æ–‡å­— (ä¿®æ”¹) */
        .pop-text { 
            font-size: 1.2rem;   /* èˆ‡æº«åº¦ç›¸åŒ */
            color: #fff;         /* èˆ‡æº«åº¦ç›¸åŒ */
        }
        /* --- [ä¿®æ”¹éƒ¨åˆ†çµæŸ] --- */

        .ci-text { 
            font-size: 0.9rem; color: #B2EBF2; margin-top: 5px; 
            border-top: 1px dashed #006064; padding-top: 5px;
        }

        footer {
            margin-top: 30px; font-size: 0.7rem; color: var(--weather-dim);
            text-align: center; border-top: 1px solid #1A4D66; padding-top: 10px;
        }
        
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        .error-msg { color: #FF5555; border: 1px solid #FF5555; padding: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <header>
        <h1>> ä¸­è¯æ°‘åœ‹æ°£è±¡åœ°éœ‡ç´”æ–‡å­—è¨Šæ¯</h1>
        <div class="sys-info">
            SYS: ONLINE<br>
            <span id="monitorStatus" class="monitor-badge">AUTO-SCAN: OFF</span>
        </div>
    </header>

    <div class="btn-group">
        <button id="enableBtn" class="btn" onclick="startMonitor()">ğŸ”Š å•Ÿå‹•ç›£æ§</button>
        <button class="btn" onclick="testAlert()">ğŸš¨ æ¸¬è©¦è­¦å ±</button>
    </div>

    <a id="quakeArea" class="quake-card" href="#" target="_blank"></a>

    <div class="control-group">
        <label>SELECT SECTOR (CITY)</label>
        <select id="citySelect" onchange="renderCityWeather()">
            <option>LOADING DATA...</option>
        </select>
    </div>

    <div id="displayArea"></div>

    <footer>
        DATA: CWA API (F-C0032-001)<br>
        UID: ...BEDC3575
    </footer>

    <script>
        const API_KEY = 'CWA-30E05081-14C2-4DAE-831E-2796BEDC3575';
        
        // é è¨­åŸå¸‚
        const DEFAULT_CITY = "è‡ºåŒ—å¸‚";
        
        let allWeatherData = [];
        let lastQuakeNo = localStorage.getItem('lastQuakeNo') || "";
        let isMonitorActive = false;
        let autoScanTimer = null;

        const citySelect = document.getElementById('citySelect');
        const displayEl = document.getElementById('displayArea');
        const quakeEl = document.getElementById('quakeArea');
        const monitorStatus = document.getElementById('monitorStatus');
        const enableBtn = document.getElementById('enableBtn');

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        try { audioCtx = new AudioContext(); } catch(e) {}

        // --- åˆå§‹åŒ– ---
        async function init() {
            // 1. å…ˆèƒŒæ™¯æŠ“å–åœ°éœ‡
            fetchQuake(false);

            // 2. æŠ“å–å…¨å°å¤©æ°£ (F-C0032-001)
            try {
                const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=${API_KEY}&format=JSON`;
                displayEl.innerHTML = `<div class="blink">CONNECTING TO SAT-NET...</div>`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.success === "true") {
                    allWeatherData = data.records.location;
                    populateCitySelect();
                    renderCityWeather(); 
                } else {
                    throw new Error("API Limit Reached");
                }
            } catch(e) {
                console.error(e);
                displayEl.innerHTML = `<div class="error-msg">DATA ERROR: ç„¡æ³•å–å¾—æ°£è±¡è³‡æ–™<br>${e.message}</div>`;
                citySelect.innerHTML = `<option>OFFLINE</option>`;
            }
        }

        // --- å¡«å…¥ç¸£å¸‚é¸å–® ---
        function populateCitySelect() {
            citySelect.innerHTML = '';
            allWeatherData.forEach(city => {
                const opt = document.createElement('option');
                opt.value = city.locationName;
                opt.text = city.locationName;
                citySelect.appendChild(opt);
            });
            citySelect.value = DEFAULT_CITY;
        }

        // --- é¡¯ç¤ºæ‰€é¸åŸå¸‚å¤©æ°£ ---
        function renderCityWeather() {
            const cityName = citySelect.value;
            const cityData = allWeatherData.find(c => c.locationName === cityName);
            
            if (!cityData) return;

            const getVal = (elName, timeIdx) => {
                const el = cityData.weatherElement.find(e => e.elementName === elName);
                if (!el) return "-";
                return el.time[timeIdx].parameter.parameterName;
            };

            const getPop = (timeIdx) => {
                const el = cityData.weatherElement.find(e => e.elementName === 'PoP');
                return el ? el.time[timeIdx].parameter.parameterName + "%" : "0%";
            };

            const getTimeLabel = (timeIdx) => {
                const el = cityData.weatherElement[0].time[timeIdx];
                const start = new Date(el.startTime);
                
                const h = start.getHours();
                let period = "";
                if (h >= 5 && h < 18) period = "ä»Šæ—¥ç™½å¤©";
                else if (h >= 18 || h < 5) period = "ä»Šæ™šæ˜æ™¨";
                
                const now = new Date();
                if (start.getDate() !== now.getDate()) {
                   period = "æ˜æ—¥é å ±";
                }
                
                return `${start.getMonth()+1}/${start.getDate()} ${start.getHours()}:00 èµ·`;
            };

            let html = `<div class="location-header">> ${cityName} æ¦‚æ³</div><div class="forecast-grid">`;

            for (let i = 0; i < 3; i++) {
                const wx = getVal('Wx', i);
                const minT = getVal('MinT', i);
                const maxT = getVal('MaxT', i);
                const ci = getVal('CI', i); 
                const pop = getPop(i);
                const timeStr = getTimeLabel(i);

                html += `
                <div class="forecast-card" data-period="${(i+1)*12}H">
                    <div class="time-text">${timeStr}</div>
                    <div class="wx-text">${wx}</div>
                    <div class="weather-row">
                        <span class="temp-text">${minT}Â° - ${maxT}Â°C</span>
                        <span class="pop-text">â˜” ${pop}</span>
                    </div>
                    <div class="ci-text">é«”æ„Ÿ: ${ci}</div>
                </div>`;
            }

            html += `</div>`;
            displayEl.innerHTML = html;
        }

        // --- åœ°éœ‡ç›£æ§ ---
        async function fetchQuake(isMonitorMode) {
            try {
                const res = await fetch(`https://opendata.cwa.gov.tw/api/v1/rest/datastore/E-A0015-001?Authorization=${API_KEY}&limit=1&format=JSON&t=${new Date().getTime()}`);
                const data = await res.json();
                if (data.records.Earthquake && data.records.Earthquake.length > 0) {
                    const q = data.records.Earthquake[0];
                    const info = q.EarthquakeInfo;
                    const currentNo = q.EarthquakeNo;
                    
                    renderQuakeHTML(q);
                    
                    if (isMonitorMode && lastQuakeNo && currentNo !== lastQuakeNo) {
                        triggerAlert(info, q.ReportContent);
                    }
                    lastQuakeNo = currentNo;
                    localStorage.setItem('lastQuakeNo', currentNo);
                }
            } catch(e) {
                console.error('åœ°éœ‡è³‡æ–™å¤±æ•—', e);
            }
        }

        function renderQuakeHTML(q) {
            const info = q.EarthquakeInfo;
            const time = new Date(info.OriginTime).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
            
            quakeEl.href = q.Web || "https://www.cwa.gov.tw/V8/C/E/index.html";
            quakeEl.innerHTML = `
                <div class="quake-top-row">
                    <span class="alert-blink">âš ï¸ LATEST REPORT</span>
                    <span style="font-weight:bold">${time}</span>
                </div>
                <div class="quake-main">M${info.EarthquakeMagnitude.MagnitudeValue} | Depth ${info.FocalDepth}km</div>
                <div class="quake-details">${q.ReportContent}</div>`;
            quakeEl.style.display = 'block';
        }

        // --- ç³»çµ±åŠŸèƒ½ ---
        function startMonitor() {
            if(isMonitorActive) return;
            if ("Notification" in window && Notification.permission !== "granted") Notification.requestPermission();
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            playBeep(0);

            isMonitorActive = true;
            enableBtn.classList.add('btn-on');
            enableBtn.innerText = ">> ç›£æ§ä¸­ (60s) <<";
            monitorStatus.classList.add('monitor-active');
            monitorStatus.innerText = "AUTO-SCAN: ACTIVE";

            fetchQuake(true);
            autoScanTimer = setInterval(() => { fetchQuake(true); }, 60000);
        }

        function testAlert() {
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            // æ¸¬è©¦ç”¨é•·æ–‡å­—
            triggerAlert({ EarthquakeMagnitude: { MagnitudeValue: "TEST" }, Epicenter: { Location: "æ’ç‰ˆæ¸¬è©¦" } }, "é€™æ˜¯ä¸€å‰‡æ¸¬è©¦è­¦å ±ï¼Œæ¸¬è©¦éå¸¸éå¸¸é•·çš„æ–‡å­—æ˜¯å¦æœƒæ­£ç¢ºæ›è¡Œï¼Œè€Œä¸æœƒç¢°åˆ°é‚Šæ¡†æˆ–æ˜¯è¢«å³ä¸‹è§’çš„ç®­é ­å£“ä½ã€‚");
        }

        function triggerAlert(info, content) {
            playBeep(1); setTimeout(() => playBeep(1), 600); setTimeout(() => playBeep(1), 1200);
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(`âš ï¸ åœ°éœ‡è­¦å ± M${info.EarthquakeMagnitude.MagnitudeValue}`, {
                    body: `${info.Epicenter.Location}\n${content}`,
                    icon: 'https://www.cwa.gov.tw/favicon.ico'
                });
            }
            document.body.classList.add('alarm-active');
            setTimeout(() => document.body.classList.remove('alarm-active'), 5000);
        }

        function playBeep(vol) {
            if(!audioCtx) return;
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = "square";
                osc.frequency.setValueAtTime(880, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            } catch(e) {}
        }

        init();
    </script>
</body>
</html>
